name: Build Bottles

on:
  workflow_call:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      formula_name:
        description: "Formula name (e.g., x86_64-linux-musl)"
        required: true
        type: string
      formula_class:
        description: "Formula class name (e.g., X8664LinuxMusl)"
        required: true
        type: string
      musl_git_url:
        description: "Musl git repository URL"
        required: true
        type: string
      musl_git_branch:
        description: "Musl git branch"
        required: false
        type: string
        default: "master"
      description_suffix:
        description: 'Description suffix (e.g., "" or " (osdev-musl)")'
        required: false
        type: string
        default: ""
      upload_to_release:
        description: "Upload bottles to release"
        required: false
        type: boolean
        default: true

jobs:
  build-bottles:
    name: Build bottle for ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            name: Apple Silicon (Sonoma)
            platform: arm64_sonoma
          - os: macos-13
            name: Intel (Ventura)
            platform: ventura

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install build dependencies
        run: |
          brew install gcc@14
          brew install wget coreutils

      - name: Create Homebrew formula
        env:
          FORMULA_CLASS: ${{ inputs.formula_class }}
          FORMULA_DESC: ${{ inputs.description_suffix }}
          REPO: ${{ github.repository }}
          VERSION: ${{ inputs.version }}
          MUSL_URL: ${{ inputs.musl_git_url }}
          MUSL_BRANCH: ${{ inputs.musl_git_branch }}
        run: |
          cat > ${{ inputs.formula_name }}.rb << FORMULA_EOF
          class ${FORMULA_CLASS} < Formula
            desc "Cross-compilation toolchain for x86_64-linux-musl target${FORMULA_DESC}"
            homepage "https://github.com/${REPO}"
            url "https://github.com/${REPO}/archive/refs/tags/${VERSION}.tar.gz"
            version "${VERSION}"
            license "MIT"

            depends_on "wget" => :build
            depends_on "coreutils" => :build
            depends_on "gnu-sed" => :build
            depends_on "make" => :build
            depends_on "gmp"
            depends_on "mpfr"
            depends_on "libmpc"
            depends_on "isl"

            uses_from_macos "texinfo" => :build
            uses_from_macos "bison" => :build
            uses_from_macos "flex" => :build

            keg_only :provided_by_macos, "to avoid conflicts with other toolchains"

            def install
              (buildpath/"local.mk").write <<~EOS
                TOOL_ROOT = #{prefix}
                BUILD_DIR = #{buildpath}/build
                MUSL_GIT_URL = ${MUSL_URL}
                MUSL_GIT_BRANCH = ${MUSL_BRANCH}
              EOS

              gcc_14 = Formula["gcc@14"]
              if gcc_14.any_version_installed?
                ENV["HOST_CC"] = "#{gcc_14.opt_bin}/gcc-14"
                ENV["HOST_CXX"] = "#{gcc_14.opt_bin}/g++-14"
              end

              system "./build.sh", "--headless", "--all"
              raise "Toolchain installation failed" unless (prefix/"bin/x86_64-linux-musl-gcc").exist?
            end

            test do
              (testpath/"hello.c").write <<~EOS
                #include <stdio.h>
                int main() {
                  printf("Hello, musl!\\\\n");
                  return 0;
                }
              EOS

              system "#{bin}/x86_64-linux-musl-gcc", "-static", "hello.c", "-o", "hello"
              assert_predicate testpath/"hello", :exist?
              output = shell_output("file hello")
              assert_match(/ELF.*x86-64.*statically linked/, output)
            end
          end
          FORMULA_EOF

      - name: Build toolchain in bottle mode
        run: |
          brew install --build-bottle ./${{ inputs.formula_name }}.rb
        env:
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Run tests
        run: |
          brew test ${{ inputs.formula_name }}
          x86_64-linux-musl-gcc --version
          echo "int main() { return 0; }" | x86_64-linux-musl-gcc -x c -static - -o test
          file test
          rm test

      - name: Create bottle
        id: bottle
        run: |
          ROOT_URL="https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}"
          brew bottle --json --root-url="${ROOT_URL}" ${{ inputs.formula_name }}

          BOTTLE_FILE=$(ls ${{ inputs.formula_name }}--*.bottle.tar.gz)
          BOTTLE_JSON=$(ls ${{ inputs.formula_name }}--*.bottle.json)

          echo "bottle_file=${BOTTLE_FILE}" >> $GITHUB_OUTPUT
          echo "bottle_json=${BOTTLE_JSON}" >> $GITHUB_OUTPUT

          SHA256=$(python3 -c "import json; print(json.load(open('${BOTTLE_JSON}'))['${{ inputs.formula_name }}']['bottle']['tags']['${{ matrix.platform }}']['sha256'])")
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT

          SIZE=$(du -h "${BOTTLE_FILE}" | cut -f1)
          echo "size=${SIZE}" >> $GITHUB_OUTPUT

          echo "âœ… Built bottle: ${BOTTLE_FILE} (${SIZE})"

      - name: Upload bottle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.platform }}
          path: |
            ${{ steps.bottle.outputs.bottle_file }}
            ${{ steps.bottle.outputs.bottle_json }}
          retention-days: 30

      - name: Save bottle metadata
        run: |
          cat > bottle-info-${{ matrix.platform }}.json << EOF
          {
            "platform": "${{ matrix.platform }}",
            "sha256": "${{ steps.bottle.outputs.sha256 }}",
            "filename": "${{ steps.bottle.outputs.bottle_file }}",
            "size": "${{ steps.bottle.outputs.size }}"
          }
          EOF

      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: metadata-${{ matrix.platform }}
          path: bottle-info-${{ matrix.platform }}.json
          retention-days: 30

  publish-bottles:
    name: Publish bottles
    needs: build-bottles
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate source tarball SHA256
        id: source_sha
        run: |
          wget -q "https://github.com/${{ github.repository }}/archive/refs/tags/${{ inputs.version }}.tar.gz"
          SOURCE_SHA=$(shasum -a 256 "${{ inputs.version }}.tar.gz" | awk '{print $1}')
          echo "sha256=${SOURCE_SHA}" >> $GITHUB_OUTPUT
          rm "${{ inputs.version }}.tar.gz"

      - name: Download all bottles
        uses: actions/download-artifact@v4
        with:
          pattern: bottle-*
          merge-multiple: true

      - name: Download all metadata
        uses: actions/download-artifact@v4
        with:
          pattern: metadata-*
          merge-multiple: true

      - name: Upload bottles to release
        if: inputs.upload_to_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for bottle in *.bottle.tar.gz; do
            gh release upload "${{ inputs.version }}" "${bottle}" \
              --repo "${{ github.repository }}" --clobber
          done

      - name: Generate complete formula
        env:
          FORMULA_CLASS: ${{ inputs.formula_class }}
          FORMULA_DESC: ${{ inputs.description_suffix }}
          REPO: ${{ github.repository }}
          VERSION: ${{ inputs.version }}
          MUSL_URL: ${{ inputs.musl_git_url }}
          MUSL_BRANCH: ${{ inputs.musl_git_branch }}
          SOURCE_SHA: ${{ steps.source_sha.outputs.sha256 }}
        run: |
          cp x86_64-linux-musl.rb complete-formula.rb

          # Replace placeholders
          sed -i.bak "s|class X8664LinuxMusl|class ${FORMULA_CLASS}|g" complete-formula.rb
          sed -i.bak "s|archive/refs/tags/v1.0.0|archive/refs/tags/${VERSION}|g" complete-formula.rb
          sed -i.bak "s|REPLACE_WITH_SOURCE_TARBALL_SHA256|${SOURCE_SHA}|g" complete-formula.rb

          # Add description suffix if provided
          if [ -n "${FORMULA_DESC}" ]; then
            sed -i.bak "s|x86_64-linux-musl target\"|x86_64-linux-musl target${FORMULA_DESC}\"|g" complete-formula.rb
          fi

          # Replace musl URL in formula
          sed -i.bak "s|git://git.musl-libc.org/musl|${MUSL_URL}|g" complete-formula.rb
          sed -i.bak "s|MUSL_GIT_BRANCH = master|MUSL_GIT_BRANCH = ${MUSL_BRANCH}|g" complete-formula.rb

          # Generate bottle block
          cat > bottle-block.rb << BOTTLE_START

          bottle do
            root_url "https://github.com/${REPO}/releases/download/${VERSION}"
          BOTTLE_START

          for platform in arm64_sonoma ventura; do
            if [ -f "bottle-info-${platform}.json" ]; then
              SHA256=$(jq -r '.sha256' "bottle-info-${platform}.json")
              printf "    sha256 cellar: :any, %-18s \"%s\"\n" "${platform}:" "${SHA256}" >> bottle-block.rb
            fi
          done

          echo "  end" >> bottle-block.rb

          # Insert bottle block
          sed -i.bak "/license \"MIT\"/r bottle-block.rb" complete-formula.rb

          # Remove template comments
          sed -i.bak '/# After CI builds bottles/,/# end/d' complete-formula.rb
          sed -i.bak '1,/^$/{ /^#/d; }' complete-formula.rb

          # Rename to final name
          mv complete-formula.rb ${{ inputs.formula_name }}.rb
          rm -f *.bak bottle-block.rb

          echo "Generated formula:"
          head -35 ${{ inputs.formula_name }}.rb

      - name: Upload formula to release
        if: inputs.upload_to_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ inputs.version }}" \
            ${{ inputs.formula_name }}.rb \
            --repo "${{ github.repository }}" --clobber

      - name: Upload formula as artifact
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula-${{ inputs.formula_name }}
          path: ${{ inputs.formula_name }}.rb
          retention-days: 90

      - name: Create summary
        run: |
          {
            echo "# ðŸ¾ Bottles Built: ${{ inputs.formula_name }}"
            echo ""
            echo "**Version:** ${{ inputs.version }}"
            echo "**Musl source:** ${{ inputs.musl_git_url }}"
            echo ""
            echo "## Download Formula"
            echo '```bash'
            echo "wget https://github.com/${{ github.repository }}/releases/download/${{ inputs.version }}/${{ inputs.formula_name }}.rb"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY

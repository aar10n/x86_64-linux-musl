name: Build Bottles (osdev-musl)

on:
  # Trigger on releases tagged with -osdev suffix (e.g., v1.0.0-osdev)
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0-osdev)"
        required: true
        type: string
      upload_to_release:
        description: "Upload bottles to release"
        required: true
        type: boolean
        default: true

jobs:
  # Only run if release tag contains -osdev or manual trigger
  check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.result }}
    steps:
      - id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.release.tag_name }}" == *-osdev* ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build bottles with osdev-musl
    needs: check
    if: needs.check.outputs.should_run == 'true'
    uses: ./.github/workflows/build-bottles-common.yml
    with:
      version: ${{ github.event_name == 'release' && github.event.release.tag_name || inputs.version }}
      formula_name: x86_64-linux-musl-osdev
      formula_class: X8664LinuxMuslOsdev
      musl_git_url: https://github.com/aar10n/osdev-musl.git
      musl_git_branch: master
      description_suffix: " (osdev-musl)"
      upload_to_release: ${{ github.event_name == 'release' || inputs.upload_to_release }}
